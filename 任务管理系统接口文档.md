## 任务管理（工作清单）系统设计与接口文档

### 一、功能概述

- **任务模板管理**  
  - 创建/编辑/删除模板  
  - 模板包含若干固定任务项（名称、描述、优先级等）  
- **工作清单生成**  
  - 选择模板后自动带出模板任务  
  - 支持对任务项微调（增删改、调整描述/优先级/预计完成时间）  
  - 生成一次“工作清单”（一次发布）  
- **工作清单执行与反馈**  
  - 用户按清单逐条执行任务  
  - 每条任务可以多次反馈，保留历史记录  
  - 支持根据反馈更新任务/清单整体状态，并回显执行记录  

后端技术栈：**Spring Boot + MyBatis + MySQL**。  
前端通过 `axios` 调用本文档的接口。

---

### 二、数据库设计（MySQL）

#### 1. 模板相关

- **任务模板表：`task_template`**

```sql
CREATE TABLE task_template (
  id            BIGINT PRIMARY KEY AUTO_INCREMENT,
  name          VARCHAR(100) NOT NULL COMMENT '模板名称',
  description   VARCHAR(500) DEFAULT NULL COMMENT '模板描述',
  created_by    VARCHAR(50)  DEFAULT NULL COMMENT '创建人',
  created_at    DATETIME     NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at    DATETIME     NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
) COMMENT='任务模板';
```

- **模板任务项表：`task_template_item`**

```sql
CREATE TABLE task_template_item (
  id              BIGINT PRIMARY KEY AUTO_INCREMENT,
  template_id     BIGINT       NOT NULL COMMENT '所属模板ID',
  name            VARCHAR(200) NOT NULL COMMENT '任务名称',
  description     VARCHAR(500) DEFAULT NULL COMMENT '任务描述',
  priority        VARCHAR(10)  DEFAULT 'medium' COMMENT '优先级 high/medium/low',
  sort_order      INT          DEFAULT 0 COMMENT '排序号',
  created_at      DATETIME     NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at      DATETIME     NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  CONSTRAINT fk_template_item_template
    FOREIGN KEY (template_id) REFERENCES task_template(id)
      ON DELETE CASCADE
) COMMENT='任务模板任务项';
```

#### 2. 工作清单（已发布任务）

- **工作清单头表：`work_list`**

```sql
CREATE TABLE work_list (
  id             BIGINT PRIMARY KEY AUTO_INCREMENT,
  title          VARCHAR(200) NOT NULL COMMENT '清单标题',
  description    VARCHAR(500) DEFAULT NULL COMMENT '说明',
  template_id    BIGINT       DEFAULT NULL COMMENT '来源模板ID（可空）',
  publisher      VARCHAR(50)  DEFAULT NULL COMMENT '发布人',
  status         VARCHAR(20)  DEFAULT 'pending' COMMENT 'pending/in_progress/completed',
  assigned_to    VARCHAR(255) DEFAULT NULL COMMENT '分配对象，逗号分隔的用户ID/姓名',
  published_at   DATETIME     NOT NULL DEFAULT CURRENT_TIMESTAMP,
  created_at     DATETIME     NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at     DATETIME     NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
) COMMENT='工作清单';
```

- **工作清单任务项表：`work_list_item`**

```sql
CREATE TABLE work_list_item (
  id               BIGINT PRIMARY KEY AUTO_INCREMENT,
  work_list_id     BIGINT       NOT NULL COMMENT '所属清单ID',
  name             VARCHAR(200) NOT NULL COMMENT '任务名称',
  description      VARCHAR(500) DEFAULT NULL COMMENT '任务描述',
  priority         VARCHAR(10)  DEFAULT 'medium',
  estimated_time   DATETIME     DEFAULT NULL COMMENT '预计完成时间',
  execution_status VARCHAR(20)  DEFAULT 'pending' COMMENT 'pending/in_progress/completed/failed',
  feedback         VARCHAR(1000) DEFAULT NULL COMMENT '最新反馈摘要',
  completed_at     DATETIME      DEFAULT NULL COMMENT '完成时间',
  sort_order       INT           DEFAULT 0,
  created_at       DATETIME      NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at       DATETIME      NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  CONSTRAINT fk_work_item_list
    FOREIGN KEY (work_list_id) REFERENCES work_list(id)
      ON DELETE CASCADE
) COMMENT='工作清单任务项';
```

#### 3. 任务执行反馈记录

- **执行记录表：`task_execution_record`**

```sql
CREATE TABLE task_execution_record (
  id                BIGINT PRIMARY KEY AUTO_INCREMENT,
  work_list_id      BIGINT      NOT NULL COMMENT '清单ID',
  work_list_item_id BIGINT      NOT NULL COMMENT '清单任务项ID',
  executor          VARCHAR(50) NOT NULL COMMENT '执行人',
  status            VARCHAR(20) NOT NULL COMMENT 'in_progress/completed/failed',
  feedback          VARCHAR(1000) DEFAULT NULL COMMENT '执行反馈内容',
  completed_at      DATETIME      DEFAULT NULL COMMENT '完成时间',
  created_at        DATETIME      NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at        DATETIME      NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  CONSTRAINT fk_exec_list
    FOREIGN KEY (work_list_id) REFERENCES work_list(id) ON DELETE CASCADE,
  CONSTRAINT fk_exec_item
    FOREIGN KEY (work_list_item_id) REFERENCES work_list_item(id) ON DELETE CASCADE
) COMMENT='任务执行反馈记录';
```

---

### 三、主要接口设计（REST API）

统一前缀建议：`/api`

#### 1. 模板管理接口

- **GET `/api/templates`**  
  - 功能：查询所有模板  
  - 响应示例：
    ```json
    [
      { "id": 1, "name": "日常巡检", "description": "设备每日巡检模板" }
    ]
    ```

- **GET `/api/templates/{id}`**  
  - 功能：获取模板详情（包含任务项）  
  - 响应示例：
    ```json
    {
      "template": { "id": 1, "name": "日常巡检", "description": "..." },
      "items": [
        { "id": 10, "name": "检查设备A", "description": "xxx", "priority": "high", "sortOrder": 1 }
      ]
    }
    ```

- **POST `/api/templates`**  
  - 功能：创建模板  
  - 请求体：
    ```json
    {
      "name": "日常巡检",
      "description": "xxx",
      "createdBy": "admin",
      "items": [
        { "name": "检查设备A", "description": "xxx", "priority": "high" },
        { "name": "检查设备B", "description": "yyy", "priority": "medium" }
      ]
    }
    ```
  - 响应：`{ "id": 1 }`

- **PUT `/api/templates/{id}`**  
  - 功能：更新模板及其任务项（通常采用全量覆盖 items 的方式）  
  - 请求体结构同 POST。

- **DELETE `/api/templates/{id}`**  
  - 功能：删除模板及其所有任务项。

#### 2. 工作清单（发布任务）接口

- **POST `/api/work-lists`**  
  - 功能：从模板或自定义任务生成一张工作清单（发布任务）  
  - 请求体（对应前端发布页面表单）：
    ```json
    {
      "title": "早班巡检清单",
      "description": "xxx",
      "templateId": 1,
      "publisher": "张三",
      "assignedTo": ["userA", "userB"],
      "tasks": [
        {
          "name": "检查设备A",
          "description": "检查电压、电流",
          "priority": "high",
          "estimatedTime": "2026-01-27T10:00:00"
        },
        {
          "name": "检查设备B",
          "description": "查看告警灯",
          "priority": "medium",
          "estimatedTime": null
        }
      ]
    }
    ```
  - 响应：`{ "id": 100 }`（新建清单 ID）

- **GET `/api/work-lists`**  
  - 功能：查询工作清单列表，可按状态过滤  
  - 查询参数：
    - `status`（可选）：`pending` / `in_progress` / `completed`  
  - 响应示例：
    ```json
    [
      {
        "id": 100,
        "title": "早班巡检清单",
        "description": "xxx",
        "status": "pending",
        "publisher": "张三",
        "assignedTo": "userA,userB",
        "publishedAt": "2026-01-27T08:00:00"
      }
    ]
    ```

- **GET `/api/work-lists/{id}`**  
  - 功能：获取工作清单详情（头 + 任务项列表）  
  - 响应示例：
    ```json
    {
      "workList": {
        "id": 100,
        "title": "早班巡检清单",
        "description": "xxx",
        "status": "in_progress",
        "publisher": "张三",
        "assignedTo": "userA,userB",
        "publishedAt": "2026-01-27T08:00:00"
      },
      "items": [
        {
          "id": 1001,
          "name": "检查设备A",
          "description": "检查电压、电流",
          "priority": "high",
          "estimatedTime": "2026-01-27T10:00:00",
          "executionStatus": "completed",
          "feedback": "已检查，状态正常",
          "completedAt": "2026-01-27T09:30:00"
        }
      ]
    }
    ```

#### 3. 任务执行反馈接口

- **POST `/api/executions`**  
  - 功能：提交一条任务执行反馈记录（保留历史），并联动更新任务项与清单状态  
  - 请求体：
    ```json
    {
      "workListId": 100,
      "workListItemId": 1001,
      "executor": "李四",
      "status": "completed",
      "feedback": "已检查，正常运行",
      "completedAt": "2026-01-27T09:30:00"
    }
    ```
  - 业务逻辑：
    - 向 `task_execution_record` 插入一条记录  
    - 更新对应 `work_list_item` 的 `execution_status` / `feedback` / `completed_at`  
    - 统计该清单下所有 `work_list_item`：
      - 若全部 `execution_status = completed` → `work_list.status = completed`
      - 若部分已执行（`in_progress` 或 `completed`），且原状态为 `pending` → 更新为 `in_progress`

- **GET `/api/executions`**  
  - 功能：根据清单及任务项，查询该任务的所有历史反馈记录，用于回显  
  - 查询参数：
    - `workListId`：清单 ID（必填）  
    - `workListItemId`：清单任务项 ID（必填）  
  - 响应示例：
    ```json
    [
      {
        "id": 1,
        "workListId": 100,
        "workListItemId": 1001,
        "executor": "李四",
        "status": "in_progress",
        "feedback": "正在检查中",
        "completedAt": null,
        "createdAt": "2026-01-27T09:00:00"
      },
      {
        "id": 2,
        "workListId": 100,
        "workListItemId": 1001,
        "executor": "李四",
        "status": "completed",
        "feedback": "已检查，正常运行",
        "completedAt": "2026-01-27T09:30:00",
        "createdAt": "2026-01-27T09:31:00"
      }
    ]
    ```

---

### 四、与前端现有页面的对接建议

- `TaskPublish.vue`  
  - 原来使用本地 `Vuex + localStorage`，可以改为：  
    - 模板下拉：`GET /api/templates`  
    - 点击“选择模板”：`GET /api/templates/{id}` 获取 `items` 后填充表单任务列表  
    - 点击“发布任务”：`POST /api/work-lists`  

- `TemplateManagement.vue`  
  - 列表：`GET /api/templates`  
  - 创建：`POST /api/templates`  
  - 编辑：`PUT /api/templates/{id}`  
  - 删除：`DELETE /api/templates/{id}`  

- `TaskExecution.vue`  
  - “我的任务”列表：`GET /api/work-lists?status=xxx`  
  - 某清单详情 + 任务项：`GET /api/work-lists/{id}`  
  - 提交执行反馈：`POST /api/executions`  
  - 若需要查看某条任务的历史反馈记录：`GET /api/executions?workListId=...&workListItemId=...`  

将上述接口和表结构落地后，就可以完全支撑你描述的：**模板 → 微调生成工作清单 → 用户逐条执行并反馈 → 历史反馈记录回显** 的完整闭环。


